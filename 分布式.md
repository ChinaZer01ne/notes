## Redis高可用哨兵模式搭建

一主二从三哨兵模式

### Redis安装

1、Redis下载

```shell
wget http://download.redis.io/releases/redis-4.0.11.tar.gz
```

2、解压

```shell
tar zxcf redis-4.0.11.tar.gz
```

3、进入目录

```shell
cd redis-4.0.11/
```

4、安装

```shell
 cd src 
 make
 yum install -y tcl
 make test
 make install PREFIX=/home/redis-sentinel #指定目录安装，注意 PREFIX 大写
```

###Redis主从配置

5、配置文件

```shell
mkdir /home/redis-sentinel/conf
cp redis.conf /home/redis-sentinel/conf
cd /home/redis-sentinel/conf
vi redis.conf	#编辑配置文件
```

将`bind 127.0.0.1`注释掉，这个是绑定能访问redis的ip地址，如果指定，那么只有指定的ip可以访问redis

将`daemonize no`修改为`daemonize yes`,设置为后台启动

```shell
cp redis.conf redis-6380.conf	
cp redis.conf redis-6381.conf	#复制两份
```

分别修改``redis-6380.conf`和`redis-6381.conf`的端口号等并且加入一下配置。

```tex
slaveof [主节点ip] [主节点端口号]	如：slaveof 192.168.1.27
```

6、启动redis

```shell
./redis-server ../conf/redis.conf 
./redis-server ../conf/redis-6380.conf 
./redis-server ../conf/redis-6381.conf 
```

到此Redis的主从配置就完成了，可以通过

```shell
 ./redis-cli -p [端口号]
```

登录redis进行测试主从复制是否成功。

### Redis哨兵配置

1、从下载文件中复制`sentinel.conf`配置文件到安装目录下

2、在配置文件中修改以下内容

```shell
port 26379	#哨兵的端口
sentinel monitor s1 <ip地址> 6379 2	
sentinel monitor s2 <ip地址> 6379 2	# 这里是主节点的配置，如果有多个master节点，则配置多行，2代表选举的时候新的leader需要获得2票
protected-mode no
```

注意：

* 此处的`<ip地址>`不要写`127.0.0.1`,否则在使用程序连接哨兵的时候，主从切换后，程序自动获取到的IP地址是`127.0.0.1:端口`，这意味着应用程序服务器上可能是没有Redis的（如果有也可能不是同一个Redis）。

* protected-mode ：关闭保护模式（默认情况下，redis node和sentinel的protected-mode都是yes，在搭建集群时，若想从远程连接redis集群，需要将redis node和sentinel的protected-mode修改为no，若只修改redis node，从远程连接sentinel后，依然是无法正常使用的，且sentinel的配置文件中没有protected-mode配置项，需要手工添加。依据redis文档的说明，若protected-mode设置为no后，需要增加密码证或是IP限制等保护机制，否则是极度危险的。）


3、将此配置文件再复制两份，分别是`sentinel-26479.conf`和`sentinel-26579.conf`

4、分别修改复制配置文件中的端口号

5、启动哨兵

```shell
./redis-sentinel ../conf/sentinel.conf
./redis-sentinel ../conf/sentinel-26479.conf
./redis-server ../conf/sentinel-26579.conf	#或者./redis-server ../conf/sentinel-26579.conf --sentinel
```

到此哨兵配置就结束了，可以模拟宕机的情况来测试主从切换。