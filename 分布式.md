#分布式



## 负载均衡

###  负载均衡策略

#### 轮询（RoundRobin）：

将请求顺序循环地发到每个服务器。当其中某个服务器发生故障，AX就把其从顺序循环队列中拿出，不参加下一次的轮询，直到其恢复正常。

#### 比率（Ratio）：

给每个服务器分配一个加权值为比例，根椐这个比例，把用户的请求分配到每个服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

#### 优先权（Priority）：

给所有服务器分组，给每个组定义优先权，将用户的请求分配给优先级最高的服务器组（在同一组内，采用预先设定的轮询或比率算法，分配用户的请求）；当最高优先级中所有服务器或者指定数量的服务器出现故障，AX将把请求送给次优先级的服务器组。这种方式，实际为用户提供一种热备份的方式。

#### 最少连接数（LeastConnection）：

AX会记录当前每台服务器或者服务端口上的连接数，新的连接将传递给连接数最少的服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

#### 最快响应时间（Fast Reponse time）：

新的连接传递给那些响应最快的服务器。当其中某个服务器发生故障，AX就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

**以上为通用的负载均衡算法，还有一些算法根据不同的需求也可能会用到，例如：**

#### 哈希算法( hash):

将客户端的源地址，端口进行哈希运算，根据运算的结果转发给一台服务器进行处理，当其中某个服务器发生故障，就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

####  基于策略的负载均衡：

针对不同的数据流设置导向规则，用户可自行编辑流量分配策略，利用这些策略对通过的数据流实施导向控制。

#### 基于数据包的内容分发：

例如判断HTTP的URL，如果URL中带有.jpg的扩展名，就把数据包转发到指定的服务器。

## 分布式事务

分布式事务实现方式

- XA
- 基于消息的分布式事务
- TCC




## 分布式锁



使用锁的方式：

​	1、分布式锁

​	2、数据库级别行锁（通过sql）

​	3、mq在单实例的时候控制并发数@JmsListener(concurrency = 1）



## 分布式系统唯一性ID生成

* 数据库自增序列
* UUID：唯一ID标准，128位，几种版本
* MongoDB的ObjectID：时间戳+机器ID+进程ID+序号
* Redis的INCR操作、Zookeeper节点的版本号

场景：

* 自增的ID：考虑安全性、部署
* 时间有序：便于通过ID判断创建时间
* 长度、是否数字类型：是否建索引





## 分布式系统常用库

* Redis：Redisson库：RLock、RMap、RQueue等对象
* Zookeeper：Netflix Curator库：Lock、Queue等对象



## 分布式锁和分布式事务区别



​	**分布式锁和分布式事务是完全不同的两个东西：**

​	**分布式锁解决的是线程竞争资源的问题，比如说减库存操作，分布式多线程下防止超买**。

​	**分布式事务解决的是多个操作的事务提交问题，比如下单并且减库存，两个操作必须在一个事务中。**



​	**分布式锁能解决分布式问题吗？**

​	如果你整个事务操作都放到一个分布式锁中，不可以，比如下单并且减库存操作，如果用一个分布式锁包裹起来，就相当于整个流程被串行化了，这样只能保证多线程访问下，对资源的竞争控制（一个一个来减库存，无并发问题），但是，**这并不能保证你下单成功，但减库存失败带来的事务问题（需要回滚）**。分布式事务不光需要原子性，还需要一致性。

​	**结论：两者没有半毛钱关系**。



## XA和JTA区别

​	**XA是由X/Open组织提出的分布式事务的架构（或者叫协议）**。XA架构主要定义了（全局）事务管理器（Transaction Manager）和（局部）资源管理器（Resource Manager）之间的接口。**XA规范不是java的规范，而是一种通用的规范**。

​	**JTA(Java Transaction API)，是J2EE的编程接口规范，它是XA协议的JAVA实现**。

​	JTA的优点很明显，就是提供了分布式事务的解决方案，严格的ACID。 
虽然JTA事务是Java提供的可用于分布式事务的一套API，但是不同的J2EE平台的实现都不一样，并且都不是很方便使用，所以，**一般在项目中不太使用**这种较为负责的API。现在业内比较常用的分布式事务解决方案主要有异步消息确保型、TCC、最大努力通知。	