# 分布式链路追踪



## SkyWalking



### 安装

#### 环境

1、`JDK8`：笔者用11以上，不兼容

2、`Elasticsearch：6.7.0`（6.X版本应该都可以）

3、`SkyWalking：6.1`



#### Elasticsearch安装

docker部署：

```shell
# 1、镜像拉取
$ docker pull elasticsearch:6.5.4
# 2、运行
docker run --name es -p 9200:9200 -p 9300:9300  -e "discovery.type=single-node" [镜像id]
# 3、修改elasticsearch.yml ，
cluster.name: "es" # 此处的名字需要与skywalking中的名称相同
network.host: 0.0.0.0
# 4、重启es
docker restart es
```



#### SkyWalking部署

1、下载

http://skywalking.apache.org/zh/downloads/

2、解压

3、修改配置

①修改`apache-skywalking-apm-bin/config`路径下的`application.yml`，主要是将`storage:h2`注释，采用`storage:elasticsearch:`。注意：`storage:elasticsearch.nameSpace`需要与es的`cluster.name`相同。

```yaml
cluster:
  standalone:
core:
  default:
    role: ${SW_CORE_ROLE:Mixed} # Mixed/Receiver/Aggregator
    restHost: ${SW_CORE_REST_HOST:192.168.1.106}
    restPort: ${SW_CORE_REST_PORT:12800}
    restContextPath: ${SW_CORE_REST_CONTEXT_PATH:/}
    gRPCHost: ${SW_CORE_GRPC_HOST:192.168.1.106}
    gRPCPort: ${SW_CORE_GRPC_PORT:11800}
    downsampling:
    - Hour
    - Day
    - Month
    recordDataTTL: ${SW_CORE_RECORD_DATA_TTL:90} # Unit is minute
    minuteMetricsDataTTL: ${SW_CORE_MINUTE_METRIC_DATA_TTL:90} # Unit is minute
    hourMetricsDataTTL: ${SW_CORE_HOUR_METRIC_DATA_TTL:36} # Unit is hour
    dayMetricsDataTTL: ${SW_CORE_DAY_METRIC_DATA_TTL:45} # Unit is day
    monthMetricsDataTTL: ${SW_CORE_MONTH_METRIC_DATA_TTL:18} # Unit is month
storage:
  elasticsearch:
    nameSpace: ${SW_NAMESPACE:"es"}
    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:192.168.1.106:9200}
    user: ${SW_ES_USER:""}
    password: ${SW_ES_PASSWORD:""}
    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2}
    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}

receiver-sharing-server:
  default:
receiver-register:
  default:
receiver-trace:
  default:
    bufferPath: ${SW_RECEIVER_BUFFER_PATH:../trace-buffer/}  # Path to trace buffer files, suggest to use absolute path
    bufferOffsetMaxFileSize: ${SW_RECEIVER_BUFFER_OFFSET_MAX_FILE_SIZE:100} # Unit is MB
    bufferDataMaxFileSize: ${SW_RECEIVER_BUFFER_DATA_MAX_FILE_SIZE:500} # Unit is MB
    bufferFileCleanWhenRestart: ${SW_RECEIVER_BUFFER_FILE_CLEAN_WHEN_RESTART:false}
    sampleRate: ${SW_TRACE_SAMPLE_RATE:10000} # The sample rate precision is 1/10000. 10000 means 100% sample in default.
    slowDBAccessThreshold: ${SW_SLOW_DB_THRESHOLD:default:200,mongodb:100} # The slow database access thresholds. Unit ms.
receiver-jvm:
  default:
receiver-clr:
  default:
service-mesh:
  default:
    bufferPath: ${SW_SERVICE_MESH_BUFFER_PATH:../mesh-buffer/}  # Path to trace buffer files, suggest to use absolute path
    bufferOffsetMaxFileSize: ${SW_SERVICE_MESH_OFFSET_MAX_FILE_SIZE:100} # Unit is MB
    bufferDataMaxFileSize: ${SW_SERVICE_MESH_BUFFER_DATA_MAX_FILE_SIZE:500} # Unit is MB
    bufferFileCleanWhenRestart: ${SW_SERVICE_MESH_BUFFER_FILE_CLEAN_WHEN_RESTART:false}
istio-telemetry:
  default:
envoy-metric:
  default:

query:
  graphql:
    path: ${SW_QUERY_GRAPHQL_PATH:/graphql}
alarm:
  default:
telemetry:
  none:

```



②修改`apache-skywalking-apm-bin/webapp`路径下的`webapp.yml`文件。将`collector:ribbon:listOfServers`修改成自己的ip地址。

```shell
server:
  port: 8080
collector:
  path: /graphql
  ribbon:
    ReadTimeout: 10000
    # Point to all backend's restHost:restPort, split by ,
    listOfServers: 192.168.1.106:12800
security:
  user:
    # username
    admin:
      # password
      password: admin
```



4、启动

在`apache-skywalking-apm-bin/bin`下执行

```shell
$ ./startup.sh 
```



5、访问`http://localhost:8080`，默认端口可以在``apache-skywalking-apm-bin/webapp/webapp.yml`中修改。



## Java-agent探针使用

idea中使用方式：

在需要监控的程序中增加虚拟机参数

```properties
# skywalking-agent.jar的局对路径
-javaagent:/home/peach/software/apache-skywalking-apm-bin/agent/skywalking-agent.jar
-Dskywalking.agent.service_name=xxx
# 或者将apache-skywalking-apm-bin/agent/config/agent.conf中的ip地址替换成实际的ip地址
-Dskywalking.collector.backend_service=192.168.1.106:11800
```



jar包使用方式：

```shell
java -javaagent:/home/peach/software/apache-skywalking-apm-bin/agent/skywalking-agent.jar  -jar xxx.jar
```

